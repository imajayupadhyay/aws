name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # Runs the workflow when code is pushed to 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup SSH Key
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem

    - name: Deploy to EC2
      run: |
        ssh -i private_key.pem -o StrictHostKeyChecking=no "$AWS_USER@$AWS_HOST" << 'EOF'
          echo "ðŸš€ Connected to AWS EC2"

          # Navigate to the project directory
          cd ~/aws

          # Pull the latest changes from GitHub
          git reset --hard  # Ensure a clean pull
          git pull origin main
          
          echo "âœ… Git Pull Successful"

          # Install backend dependencies
          cd backend
          npm install
          echo "âœ… Backend Dependencies Installed"

          # Install frontend dependencies and build it
          cd ../my-mini-app
          npm install
          npm run build
          echo "âœ… Frontend Build Complete"

          # Move back to backend
          cd ../backend

          # Restart PM2 to apply changes
          pm2 restart server || pm2 start server.js --name mern-app
          echo "âœ… PM2 Server Restarted"

          # Restart Nginx (Important)
          sudo systemctl restart nginx
          echo "âœ… Nginx Restarted"

        EOF
